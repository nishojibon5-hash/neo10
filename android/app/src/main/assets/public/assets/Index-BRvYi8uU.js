import{c as P,r as s,g as ee,j as e,u as O,a as te,P as W,b as se,d as ae,e as re,f as L,h as C}from"./index-Cny3-YC3.js";import{P as oe,A as R,a as B,b as H,V as ne,L as ie}from"./Layout-63m88gTv.js";import{u as T}from"./upload-Bx7WDt3n.js";import{B as _}from"./button-vWn4QgZQ.js";import{P as le}from"./PostCard-CWJJR5AN.js";const ce=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],de=P("image",ce);const me=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],ue=P("smile",me);const pe=[["path",{d:"M12 4v16",key:"1654pz"}],["path",{d:"M4 7V5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2",key:"e0r10z"}],["path",{d:"M9 20h6",key:"s66wpe"}]],he=P("type",pe);const fe=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],F=P("upload",fe),Y=s.memo(({story:t})=>e.jsxs("div",{className:"relative w-28 shrink-0 overflow-hidden rounded-xl border",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"h-40 w-28 object-cover",loading:"lazy"}):e.jsx("video",{src:t.video_url,className:"h-40 w-28 object-cover",autoPlay:!0,muted:!0,loop:!0,playsInline:!0}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/40 to-black/0"}),e.jsx("div",{className:"absolute bottom-0 p-2 text-xs font-medium text-white drop-shadow",children:t.name})]}));Y.displayName="StoryItem";const xe=s.memo(function(){const[a,u]=s.useState([]),[o,m]=s.useState(!1),x=s.useRef(null),n=s.useCallback(async()=>{try{const c=await fetch("/api/stories").catch(()=>null);if(!c||!c.ok)return;const h=((await c.json()).stories||[]).map(p=>({id:p.id,name:p.name||"Story",avatar:p.avatar_url||void 0,image_url:p.image_url||void 0,video_url:p.video_url||void 0}));u(h)}catch(c){console.warn("Stories load error:",c)}},[]);s.useEffect(()=>{n();const c=setInterval(n,3e4);return()=>clearInterval(c)},[n]);const i=s.useCallback(()=>x.current?.click(),[]),l=s.useCallback(async c=>{const r=c.target.files?.[0];if(r){m(!0);try{const h=await T(r),p=r.type.startsWith("video")?{video_url:h}:{image_url:h},g=await fetch("/api/stories",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${ee()}`},body:JSON.stringify(p)});if(!g.ok){const b=await g.json().catch(()=>({}));throw new Error(b.error||"Share failed")}await n()}catch(h){alert(h?.message||"Upload failed")}finally{m(!1),c.target.value=""}}},[n]);return e.jsxs("div",{className:"no-scrollbar flex gap-3 overflow-x-auto",children:[e.jsxs("button",{onClick:i,disabled:o,className:"relative flex w-28 shrink-0 flex-col overflow-hidden rounded-xl border bg-card text-left hover:bg-muted/60 disabled:opacity-50",children:[e.jsx("div",{className:"h-32 w-full bg-muted/60"}),e.jsx("div",{className:"p-2 text-sm",children:o?"Uploading...":"Create story"}),e.jsx("div",{className:"absolute bottom-2 left-2 grid place-items-center size-7 rounded-full bg-primary text-primary-foreground border-2 border-white shadow",children:e.jsx(oe,{className:"size-4"})}),e.jsx("input",{ref:x,type:"file",accept:"image/*,video/*",onChange:l,className:"hidden",disabled:o})]}),a.map(c=>e.jsx(Y,{story:c},c.id))]})});function ge(t){const a=s.useRef({value:t,previous:t});return s.useMemo(()=>(a.current.value!==t&&(a.current.previous=a.current.value,a.current.value=t),a.current.previous),[t])}var U="Switch",[be]=re(U),[ve,ye]=be(U),q=s.forwardRef((t,a)=>{const{__scopeSwitch:u,name:o,checked:m,defaultChecked:x,required:n,disabled:i,value:l="on",onCheckedChange:c,form:r,...h}=t,[p,g]=s.useState(null),b=O(a,w=>g(w)),y=s.useRef(!1),N=p?r||!!p.closest("form"):!0,[j,k]=te({prop:m,defaultProp:x??!1,onChange:c,caller:U});return e.jsxs(ve,{scope:u,checked:j,disabled:i,children:[e.jsx(W.button,{type:"button",role:"switch","aria-checked":j,"aria-required":n,"data-state":G(j),"data-disabled":i?"":void 0,disabled:i,value:l,...h,ref:b,onClick:se(t.onClick,w=>{k($=>!$),N&&(y.current=w.isPropagationStopped(),y.current||w.stopPropagation())})}),N&&e.jsx(D,{control:p,bubbles:!y.current,name:o,value:l,checked:j,required:n,disabled:i,form:r,style:{transform:"translateX(-100%)"}})]})});q.displayName=U;var J="SwitchThumb",V=s.forwardRef((t,a)=>{const{__scopeSwitch:u,...o}=t,m=ye(J,u);return e.jsx(W.span,{"data-state":G(m.checked),"data-disabled":m.disabled?"":void 0,...o,ref:a})});V.displayName=J;var we="SwitchBubbleInput",D=s.forwardRef(({__scopeSwitch:t,control:a,checked:u,bubbles:o=!0,...m},x)=>{const n=s.useRef(null),i=O(n,x),l=ge(u),c=ae(a);return s.useEffect(()=>{const r=n.current;if(!r)return;const h=window.HTMLInputElement.prototype,g=Object.getOwnPropertyDescriptor(h,"checked").set;if(l!==u&&g){const b=new Event("click",{bubbles:o});g.call(r,u),r.dispatchEvent(b)}},[l,u,o]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:u,...m,tabIndex:-1,ref:i,style:{...m.style,...c,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});D.displayName=we;function G(t){return t?"checked":"unchecked"}var K=q,je=V;const X=s.forwardRef(({className:t,...a},u)=>e.jsx(K,{className:L("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",t),...a,ref:u,children:e.jsx(je,{className:L("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));X.displayName=K.displayName;function Ne({title:t,onClose:a}){return e.jsxs("div",{className:"flex items-center justify-between border-b px-3 py-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:t}),e.jsx("button",{onClick:a,className:"rounded-full px-2 py-1 text-xs hover:bg-muted/60",children:"Close"})]})}function ke(t){const a=t.match(/(?:youtu\.be\/|v=|embed\/)([A-Za-z0-9_-]{6,})/);return`<div class="rounded-lg overflow-hidden bg-black">
    <iframe src="${`https://www.youtube.com/embed/${a?a[1]:t}?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1`}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen class="w-full aspect-video border-0"></iframe>
  </div>`}function Ce(t){return`<div class="rounded-lg overflow-hidden bg-black">
    <iframe src="${`https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(t)}&show_text=false&autoplay=true&mute=true`}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen class="w-full aspect-video border-0"></iframe>
  </div>`}function Se(t){return/\.(png|jpe?g|gif|webp|avif)(\?.*)?$/i.test(t.trim())}function M(t){const a=t.trim();return/\.(mp4|webm|ogg)(\?.*)?$/i.test(a)||a.startsWith("/api/assets/")}function _e(t){const a=t.match(/<iframe[^>]+src=["']([^"']+)["']/i);return a?a[1]:null}function Pe(t){const a=t.trim();if(!a)return{};const o=(a.startsWith("<iframe")?_e(a):null)||a;return/youtube\.com|youtu\.be/i.test(o)?{html:ke(o)}:/facebook\.com|fb\.watch/i.test(o)&&/video|videos|watch|plugins\/video\.php/i.test(o)?{html:Ce(o)}:Se(o)?{imageUrl:o}:/^https?:\/\//i.test(o)&&/\.(mp4|webm|ogg)(\?.*)?$/i.test(o)?{html:`<video src="${o}" class="w-full rounded-lg" playsinline muted autoplay loop controlslist="nodownload noplaybackrate" />`}:{}}function Ue(){const[t,a]=s.useState(!1),[u,o]=s.useState(1),[m,x]=s.useState("text"),[n,i]=s.useState(""),[l,c]=s.useState(""),[r,h]=s.useState(""),[p,g]=s.useState(""),[b,y]=s.useState("post"),[N,j]=s.useState(!1),[k,w]=s.useState(!1),$=s.useMemo(()=>n&&n.trim().length>0||!!l.trim()||!!r,[n,l,r]),S=s.useCallback(()=>{a(!1),o(1),x("text"),i(""),c(""),h(""),g(""),y("post"),j(!1),w(!1)},[]),Z=s.useCallback(async()=>{let d=Pe(l);if(!d.imageUrl&&!d.html&&/^https?:\/\//i.test(l.trim()))try{const v=await fetch(`/api/resolve?url=${encodeURIComponent(l.trim())}`);if(v.ok){const f=await v.json();f.kind==="image"?d={imageUrl:f.url}:f.kind==="video"&&(d={html:`<video src="${f.url}" class="w-full rounded-lg" controls playsinline />`})}}catch{}!d.imageUrl&&!d.html&&M(l.trim())&&(d={html:`<video src="${l.trim()}" class="w-full rounded-lg" controls playsinline />`}),d.imageUrl&&h(d.imageUrl),d.html&&g(d.html),d.html&&m!=="html"&&x("html"),o(2)},[l,m]),Q=s.useCallback(async()=>{w(!0);try{const d=localStorage.getItem("token")||"";let v=n,f=m,A=r||void 0,z;!p&&M(l.trim())&&(z=l.trim()),p&&(f="html",v=`${n.trim()?`<div class="whitespace-pre-wrap">${n.replace(/</g,"&lt;")}</div>`:""}${p}`,A=void 0,z=void 0);const I=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json",Authorization:d?`Bearer ${d}`:""},body:JSON.stringify({content:v,content_mode:f,image_url:A,video_url:z,type:b,monetized:N})});if(I.status===401){alert("Please login to post."),window.location.href="/login";return}if(I.ok)S(),window.dispatchEvent(new Event("feed:refresh"));else{const E=await I.json().catch(()=>({}));alert(E.error?JSON.stringify(E.error):"Failed to post")}}catch{alert("Network error")}finally{w(!1)}},[n,m,r,p,l,b,N,S]);return t?e.jsxs("div",{className:"rounded-xl border bg-card overflow-hidden",children:[e.jsx(Ne,{title:u===1?"Create post":"Post options",onClose:S}),u===1?e.jsxs("div",{className:"p-3 flex items-start gap-3",children:[e.jsxs(R,{className:"h-9 w-9",children:[e.jsx(B,{src:C()?.avatar_url||"https://i.pravatar.cc/100?img=68",alt:C()?.name||"You"}),e.jsx(H,{children:(C()?.name||"YOU").slice(0,2).toUpperCase()})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsxs("button",{onClick:()=>x("text"),className:`px-2 py-1 rounded-full ${m==="text"?"bg-primary text-primary-foreground":"bg-muted/60"}`,children:[e.jsx(he,{className:"inline size-3 mr-1"}),"Text"]}),e.jsx("button",{onClick:()=>x("html"),className:`px-2 py-1 rounded-full ${m==="html"?"bg-primary text-primary-foreground":"bg-muted/60"}`,children:"HTML"}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx("span",{className:"text-xs",children:"Type:"}),e.jsx("button",{onClick:()=>y("post"),className:`px-2 py-1 rounded-full text-xs ${b==="post"?"bg-muted":"bg-muted/40"}`,children:"Post"}),e.jsx("button",{onClick:()=>y("video"),className:`px-2 py-1 rounded-full text-xs ${b==="video"?"bg-muted":"bg-muted/40"}`,children:"Video"}),e.jsx("button",{onClick:()=>y("reel"),className:`px-2 py-1 rounded-full text-xs ${b==="reel"?"bg-muted":"bg-muted/40"}`,children:"Reel"})]})]}),m==="html"?e.jsx("textarea",{value:n,onChange:d=>i(d.target.value),placeholder:"Write/paste HTML...",className:"min-h-36 w-full rounded-md border bg-background p-2 text-sm"}):e.jsx("textarea",{value:n,onChange:d=>i(d.target.value),placeholder:"What's on your mind?",className:"min-h-36 w-full resize-y rounded-md border bg-background p-2 text-sm"}),e.jsx("textarea",{value:l,onChange:d=>c(d.target.value),placeholder:"Paste image URL or YouTube/Facebook link or iframe embed code",className:"min-h-20 w-full rounded-md bg-muted/60 p-2 text-sm"}),r?e.jsx("img",{src:r,alt:"preview",className:"mt-2 rounded-md max-w-full h-auto"}):null,!r&&M(l)?e.jsx("video",{src:l.trim(),className:"mt-2 w-full rounded-md",controls:!0}):null,e.jsxs("div",{className:"flex items-center justify-between pt-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsxs("label",{className:"inline-flex items-center gap-1 cursor-pointer px-2 py-1 rounded bg-muted/60",children:[e.jsx(F,{className:"size-3"})," Upload photo",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:async d=>{const v=d.target.files?.[0];if(v)try{const f=await T(v);h(f),c("")}catch(f){alert(f?.message||"Upload failed")}}})]}),e.jsxs("label",{className:"inline-flex items-center gap-1 cursor-pointer px-2 py-1 rounded bg-muted/60",children:[e.jsx(F,{className:"size-3"})," Upload video",e.jsx("input",{type:"file",accept:"video/*",className:"hidden",onChange:async d=>{const v=d.target.files?.[0];if(v)try{const f=await T(v);g(""),h(""),c(f),x("text")}catch(f){alert(f?.message||"Upload failed")}}})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:S,children:"Cancel"}),e.jsx(_,{size:"sm",onClick:Z,disabled:!$,children:"Next"})]})]})]})]}):e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"rounded-md border bg-background p-3 text-sm",children:[m==="html"?e.jsx("div",{className:"prose prose-sm max-w-none",dangerouslySetInnerHTML:{__html:p?`${n.trim()?`<div class="whitespace-pre-wrap">${n.replace(/</g,"&lt;")}</div>`:""}${p}`:n}}):e.jsx("div",{className:"whitespace-pre-wrap",children:n}),r?e.jsx("img",{src:r,alt:"preview",className:"mt-2 rounded-md max-w-full h-auto"}):null]}),e.jsx("div",{className:"rounded-md border p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium",children:"Monetize"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Turn on ads for this post"})]}),e.jsx(X,{checked:N,onCheckedChange:j})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>o(1),disabled:k,children:"Back"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{variant:"outline",size:"sm",onClick:S,disabled:k,children:"Discard"}),e.jsx(_,{size:"sm",onClick:Q,disabled:k,children:k?"Sharing...":"Share"})]})]})]})]}):e.jsxs("div",{className:"rounded-xl border bg-card",children:[e.jsxs("div",{className:"p-3 flex items-center gap-3",children:[e.jsxs(R,{className:"h-9 w-9",children:[e.jsx(B,{src:C()?.avatar_url||"https://i.pravatar.cc/100?img=68",alt:C()?.name||"You"}),e.jsx(H,{children:(C()?.name||"YOU").slice(0,2).toUpperCase()})]}),e.jsx("button",{onClick:()=>{a(!0),o(1)},className:"flex-1 h-11 rounded-full bg-muted/60 px-4 text-left text-sm text-muted-foreground hover:bg-muted",children:"What's on your mind?"})]}),e.jsxs("div",{className:"grid grid-cols-3 divide-x border-t text-sm",children:[e.jsxs("button",{className:"flex items-center justify-center gap-2 py-2.5 hover:bg-muted/60",children:[e.jsx(ne,{className:"size-5 text-red-500"})," Live video"]}),e.jsxs("button",{className:"flex items-center justify-center gap-2 py-2.5 hover:bg-muted/60",children:[e.jsx(de,{className:"size-5 text-green-500"})," Photo"]}),e.jsxs("button",{className:"flex items-center justify-center gap-2 py-2.5 hover:bg-muted/60",children:[e.jsx(ue,{className:"size-5 text-purple-500"})," Feeling"]})]})]})}const $e=s.memo(Ue),ze=s.memo(()=>e.jsxs("div",{className:"rounded-xl border bg-card p-4 animate-pulse",children:[e.jsx("div",{className:"h-10 bg-muted rounded-full w-20 mb-3"}),e.jsx("div",{className:"h-4 bg-muted rounded w-full mb-2"}),e.jsx("div",{className:"h-4 bg-muted rounded w-3/4"})]})),Ie=[{id:"1",author:{name:"Ayesha Khan",avatar:"https://i.pravatar.cc/100?img=15"},content:"আজকে ঢাকার আকাশটা দারুণ সুন্দর! ☁️",image:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1400&auto=format&fit=crop",createdAt:"1h",likes:120,comments:24,shares:12},{id:"2",author:{name:"Rahim Uddin",avatar:"https://i.pravatar.cc/100?img=24"},content:"Weekend trip with friends!",image:"https://images.unsplash.com/photo-1520975922284-ec47b4b66804?q=80&w=1400&auto=format&fit=crop",createdAt:"3h",likes:89,comments:17,shares:9},{id:"3",author:{name:"JOY BANGLA",avatar:"https://i.pravatar.cc/100?img=12"},content:"Welcome to JOY BANGLA — a fast, modern, Facebook Lite inspired experience.",createdAt:"5h",likes:56,comments:6,shares:2}];function Ee(){const[t,a]=s.useState(Ie),[u,o]=s.useState(!0),[m,x]=s.useState(null),n=s.useCallback(async()=>{try{x(null);const i=await fetch("/api/feed").catch(()=>null);if(!i||!i.ok){o(!1);return}const c=((await i.json()).posts||[]).map(r=>({id:r.id,author:{id:r.user_id,name:r.user_name,avatar:r.user_avatar||"https://i.pravatar.cc/100?img=12"},content:r.content||"",mode:r.content_mode==="html"?"html":"text",image:r.image_url||void 0,video:r.video_url||void 0,createdAt:new Date(r.created_at).toLocaleString(),likes:Number(r.likes||0),comments:Number(r.comments||0),shares:0,monetized:!!r.monetized}));c.length&&a(c),o(!1)}catch(i){console.warn("Feed loading error:",i),o(!1)}},[]);return s.useEffect(()=>{n();const i=()=>n();return window.addEventListener("feed:refresh",i),()=>window.removeEventListener("feed:refresh",i)},[n]),e.jsx(ie,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(xe,{}),e.jsx($e,{}),u&&e.jsx("div",{className:"space-y-4",children:Array.from({length:3}).map((i,l)=>e.jsx(ze,{},l))}),m&&e.jsx("div",{className:"rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-600",children:m}),e.jsx("div",{className:"space-y-4",children:t.map(i=>e.jsx(le,{post:i},i.id))})]})})}const Be=s.memo(Ee);export{Be as default};
