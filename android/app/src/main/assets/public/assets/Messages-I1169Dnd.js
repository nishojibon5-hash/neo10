import{i as N,r as o,g as d,j as t,h as k}from"./index-Cny3-YC3.js";import{L as C}from"./Layout-63m88gTv.js";import{I as S,B as l}from"./button-vWn4QgZQ.js";import{u as $}from"./upload-Bx7WDt3n.js";function I(){const j=N(),[w,y]=o.useState([]),[n,u]=o.useState(null),[_,b]=o.useState([]),[r,p]=o.useState(""),x=o.useRef(null),v=async()=>{const e=await fetch("/api/messages/conversations",{headers:{Authorization:`Bearer ${d()}`}});if(e.ok){const s=await e.json();y(s.conversations||[]),!n&&s.conversations?.[0]&&u(s.conversations[0])}},g=async e=>{const s=await fetch(`/api/messages/${e}`,{headers:{Authorization:`Bearer ${d()}`}});if(s.ok){const a=await s.json();b(a.messages||[]),setTimeout(()=>x.current?.scrollIntoView({behavior:"smooth"}),50)}};o.useEffect(()=>{v()},[]),o.useEffect(()=>{n&&g(n.id)},[n?.id]),o.useEffect(()=>{const e=new URLSearchParams(j.search),s=e.get("user")||e.get("userId");(async()=>{if(s)try{const a=await fetch(`/api/messages/ensure/${s}`,{method:"POST",headers:{Authorization:`Bearer ${d()}`}});if(a.ok){await v();const i=await a.json().catch(()=>({})),c=i.conversation&&i.conversation.id;c&&u(f=>f&&f.id===c?f:{id:c,peer_id:s,peer_name:i.conversation?.peer_name||""})}}catch{}})()},[]);const m=async e=>{if(!n)return;const s={content:e.content??void 0,content_type:e.content_type??void 0,attachment_url:e.attachment_url??void 0,attachment_type:e.attachment_type??void 0};(await fetch(`/api/messages/${n.id}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d()}`},body:JSON.stringify(s)})).ok&&(await g(n.id),p(""))},h=async(e,s)=>{const a=document.createElement("input");a.type="file",a.accept=e,a.onchange=async()=>{const i=a.files?.[0];if(!i)return;const c=await $(i);await m({attachment_url:c,attachment_type:s})},a.click()};return t.jsx(C,{children:t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-[300px_minmax(0,1fr)] gap-3",children:[t.jsxs("aside",{className:"rounded-xl border bg-card overflow-hidden",children:[t.jsx("div",{className:"p-2 font-semibold",children:"Chats"}),t.jsx("div",{className:"divide-y max-h-[70vh] overflow-auto",children:w.map(e=>t.jsx("button",{onClick:()=>u(e),className:`w-full text-left px-3 py-2 hover:bg-muted/60 ${n?.id===e.id?"bg-muted":""}`,children:t.jsx("div",{className:"font-medium",children:e.peer_name})},e.id))})]}),t.jsx("section",{className:"rounded-xl border bg-card flex flex-col h-[70vh]",children:n?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"p-2 border-b font-semibold",children:n.peer_name}),t.jsxs("div",{className:"flex-1 overflow-auto p-3 space-y-2",children:[_.map(e=>t.jsxs("div",{className:`max-w-[80%] rounded-lg p-2 ${e.sender_id===k()?.id?"bg-primary text-primary-foreground ml-auto":"bg-muted"}`,children:[e.content?t.jsx("div",{className:"whitespace-pre-wrap text-sm",children:e.content}):null,e.attachment_url?e.attachment_type==="video"?t.jsx("video",{src:e.attachment_url,className:"rounded mt-1 w-full h-auto",controls:!0}):e.attachment_type==="audio"?t.jsx("audio",{src:e.attachment_url,className:"mt-1 w-full",controls:!0}):t.jsx("img",{src:e.attachment_url,className:"rounded mt-1 w-full h-auto"}):null]},e.id)),t.jsx("div",{ref:x})]}),t.jsxs("div",{className:"p-2 border-t flex items-center gap-2",children:[t.jsx(S,{value:r,onChange:e=>p(e.target.value),placeholder:"Message",onKeyDown:e=>{e.key==="Enter"&&r.trim()&&m({content:r})}}),t.jsx(l,{onClick:()=>r.trim()&&m({content:r}),children:"Send"}),t.jsx(l,{variant:"outline",onClick:()=>h("image/*","image"),children:"Photo"}),t.jsx(l,{variant:"outline",onClick:()=>h("video/*","video"),children:"Video"}),t.jsx(l,{variant:"outline",onClick:()=>h("audio/*","audio"),children:"Audio"})]})]}):t.jsx("div",{className:"flex-1 grid place-items-center text-sm text-muted-foreground",children:"Select a chat"})})]})})}export{I as default};
